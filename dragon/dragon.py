import re
import discord
import random
from redbot.core import commands, data_manager, Config, checks, bot

from .eris_event_lib import ErisEventMixin

BaseCog = getattr(commands, "Cog", object)

RETYPE = type(re.compile("a"))

# from https://www.asciiart.eu/mythology/dragons
dragonart = [
    r"""
                                                /===-_---~~~~~~~~~------____
                                                |===-~___                _,-'
                -==\                         `//~\   ~~~~`---.___.-~~
            ______-==|                         | |  \           _-~`
    __--~~~  ,-/-==\                        | |   `\        ,'
    _-~       /'    |  \                      / /      \      /
.'        /       |   \                   /' /        \   /'
/  ____  /         |    \`\.__/-~~ ~ \ _ _/'  /          \/'
/-'~    ~~~~~---__  |     ~-/~         ( )   /'        _--~`
                \_|      /        _)   ;  ),   __--~~
                    '~~--_/      _-~/-  / \   '-~ \
                {\__--_/}    / \_>- )<__\      \
                /'   (_/  _-~  | |__>--<__|      |
                |0  0 _/) )-~     | |__>--<__|     |
                / /~ ,_/       / /__>---<__/      |
                o o _//        /-~_>---<__-~      /
                (^(~          /~_>---<__-      _-~
                ,/|           /__>--<__/     _-~
            ,//('(          |__>--<__|     /                  .----_
            ( ( '))          |__>--<__|    |                 /' _---_~\
        `-)) )) (           |__>--<__|    |               /'  /     ~\`\
        ,/,'//( (             \__>--<__\    \            /'  //        ||
    ,( ( ((, ))              ~-__>--<_~-_  ~--____---~' _/'/        /'
    `~/  )` ) ,/|                 ~-_~>--<_/-__       __-~ _/
._-~//( )/ )) `                    ~~-'_/_/ /~~~~~~~__--~
;'( ')/ ,)(                              ~~~~~~~~~~
' ') '( (/
    '   '  `
    """,
    r"""
\****__              ____                                              
    |    *****\_      --/ *\-__                                          
    /_          (_    ./ ,/----'                                         
    \__         (_./  /                                                
        \__           \___----^__                                       
        _/   _                  \                                      
|    _/  __/ )\"\ _____         *\                                    
|\__/   /    ^ ^       \____      )                                   
    \___--"                    \_____ )                                  
    """,
    r"""
                ______________                               
    ,===:'.,            `-._                           
            `:.`---.__         `-._                       
            `:.     `--.         `.                     
                \.        `.         `.                   
        (,,(,    \.         `.   ____,-`.,                
    (,'     `/   \.   ,--.___`.'                         
,  ,'  ,--.  `,   \.;'         `                         
`{D, {    \  :    \;                                    
    V,,'    /  /    //                                    
    j;;    /  ,' ,-//.    ,---.      ,                    
    \;'   /  ,' /  _  \  /  _  \   ,'/                    
        \   `'  / \  `'  / \  `.' /                     
        `.___,'   `.__,'   `.__,'  
    """,
    r"""
     <>=======() 
(/\___   /|\\          ()==========<>_
      \_/ | \\        //|\   ______/ \)
        \_|  \\      // | \_/
          \|\/|\_   //  /\/
           (oo)\ \_//  /
          //_/\_\/ /  |
         @@/  |=\  \  |
              \_=\_ \ |
                \==\ \|\_ snd
             __(\===\(  )\
            (((~) __(_/   |
                 (((~) \  /
                 ______/ /
                 '------'
    """,
    r"""
                     ___====-_  _-====___
           _--^^^#####//      \\#####^^^--_
        _-^##########// (    ) \\##########^-_
       -############//  |\^^/|  \\############-
     _/############//   (@::@)   \\############\_
    /#############((     \\//     ))#############\
   -###############\\    (oo)    //###############-
  -#################\\  / VV \  //#################-
 -###################\\/      \//###################-
_#/|##########/\######(   /\   )######/\##########|\#_
|/ |#/\#/\#/\/  \#/\##\  |  |  /##/\#/  \/\#/\#/\#| \|
`  |/  V  V  `   V  \#\| |  | |/#/  V   '  V  V  \|  '
   `   `  `      `   / | |  | | \   '      '  '   '
                    (  | |  | |  )
                   __\ | |  | | /__
                  (vvv(VVV)(VVV)vvv)
    """,
    r"""
                         /\         /\__
                   // \       (  0 )_____/\            __
                  // \ \     (vv          o|          /^v\
                //    \ \   (vvvv  ___-----^        /^^/\vv\
              //  /     \ \ |vvvvv/               /^^/    \v\
             //  /       (\\/vvvv/              /^^/       \v\
            //  /  /  \ (  /vvvv/              /^^/---(     \v\
           //  /  /    \( /vvvv/----(O        /^^/           \v\
          //  /  /  \  (/vvvv/               /^^/             \v|
        //  /  /    \( vvvv/                /^^/               ||
       //  /  /    (  vvvv/                 |^^|              //
      //  / /    (  |vvvv|                  /^^/            //
     //  / /   (    \vvvvv\          )-----/^^/           //
    // / / (          \vvvvv\            /^^^/          //
   /// /(               \vvvvv\        /^^^^/          //
  ///(              )-----\vvvvv\    /^^^^/-----(      \\
 //(                        \vvvvv\/^^^^/               \\
/(                            \vvvv^^^/                 //
                                \vv^/         /        //
                                             /<______//
                                            <<<------/
                                             \<
                                               \
    """,
    r'''
                                           ..                                     
                                     ,o""""o                                   
                                  ,o$"     o                                   
                               ,o$$$                                           
                             ,o$$$'                                            
                           ,o$"o$'                                             
                         ,o$$"$"'                                              
                      ,o$"$o"$"'                                               
                   ,oo$"$"$"$"$$`                      ,oooo$$$$$$$$oooooo.    
                ,o$$$"$"$"$"$"$"o$`..             ,$o$"$$"$"'            `oo.o 
             ,oo$$$o"$"$"$"$  $"$$$"$`o        ,o$$"o$$$o$'                 `o 
          ,o$"$"$o$"$"$"$  $"$$o$$o $$o`o   ,$$$$$o$"$$o'                    $ 
        ,o"$$"'  `$"$o$" o$o$o"  $$$o$o$oo"$$$o$"$$"$o"'                     $ 
     ,o$"'        `"$ "$$o$$" $"$o$o$$"$o$$o$o$o"$"$"`""o                   '  
   ,o$'          o$ `"$"$o "$o$$o$$$"$$$o"$o$$o"$$$    `$$                     
  ,o'           (     `" o$"$o"$o$$$"$o$"$"$o$"$$"$ooo|  ``                    
 $"$             `    (   `"o$$"$o$o$$ "o$o"   $o$o"$"$    )                   
(  `                   `    `o$"$$o$" "o$$     "o /|"$o"                       
 `                           `$o$$$$"" o$      "o$\|"$o'                       
                              `$o"$"$ $ "       `"$"$o$                        
                               "$$"$$ "oo         ,$""$                        
                               $"$o$$""o"          ,o$"$                       
                               $$"$$"$ "o           `,",                       
                     ,oo$oo$$$$$$"$o$$$ ""o                                    
                  ,o$$"o"o$o$$o$$$"$o$$oo"oo                                   
                ,$"oo"$$$$o$$$$"$$$o"o$o"o"$o o                                
               ,$$$""$$o$,      `$$$$"$$$o""$o $o                              
               $o$o$"$,          `$o$"$o$o"$$o$ $$o                            
              $$$o"o$$           ,$$$$o$$o"$"$$ $o$$oo      ,                  
              "$o$$$ $`.        ,"$$o$"o$""$$$$ `"$o$$oo    `o                 
              `$o$o$"$o$o`.  ,.$$"$o$$"$$"o$$$$   `$o$$ooo    $$ooooooo        
                `$o$"$o"$"$$"$$"$"$$o$$o"$$o"        `"$o$o            `"o     
                   `$$"$"$o$$o$"$$"$ $$$  $ "           `$"$o            `o    
                      `$$"o$o"$o"$o$ "  o $$$o            `$$"o          ,$    
                         (" ""$"""     o"" "o$o             `$$ooo     ,o$$    
                              $$"""o   (   "$o$$$"o            `$o$$$o$"$'     
                                ) ) )           )  ) )  
    ''',
    r'''
                                            ,   ,                                
                                        $,  $,     ,                         
                                        "ss.$ss. .s'                         
                                ,     .ss$$$$$$$$$$s,                        
                                $. s$$$$$$$$$$$$$$`$$Ss                      
                                "$$$$$$$$$$$$$$$$$$o$$$       ,              
                               s$$$$$$$$$$$$$$$$$$$$$$$$s,  ,s               
                              s$$$$$$$$$"$$$$$$""""$$$$$$"$$$$$,             
                              s$$$$$$$$$$s""$$$$ssssss"$$$$$$$$"             
                             s$$$$$$$$$$'         `"""ss"$"$s""              
                             s$$$$$$$$$$,              `"""""$  .s$$s        
                             s$$$$$$$$$$$$s,...               `s$$'  `       
                         `ssss$$$$$$$$$$$$$$$$$$$$####s.     .$$"$.   , s-   
                           `""""$$$$$$$$$$$$$$$$$$$$#####$$$$$$"     $.$'    
                                 "$$$$$$$$$$$$$$$$$$$$$####s""     .$$$|     
                                   "$$$$$$$$$$$$$$$$$$$$$$$$##s    .$$" $    
                                   $$""$$$$$$$$$$$$$$$$$$$$$$$$$$$$$"   `    
                                  $$"  "$"$$$$$$$$$$$$$$$$$$$$S""""'         
                             ,   ,"     '  $$$$$$$$$$$$$$$$####s             
                             $.          .s$$$$$$$$$$$$$$$$$####"            
                 ,           "$s.   ..ssS$$$$$$$$$$$$$$$$$$$####"            
                 $           .$$$S$$$$$$$$$$$$$$$$$$$$$$$$#####"             
                 Ss     ..sS$$$$$$$$$$$$$$$$$$$$$$$$$$$######""              
                  "$$sS$$$$$$$$$$$$$$$$$$$$$$$$$$$########"                  
           ,      s$$$$$$$$$$$$$$$$$$$$$$$$#########""'                      
           $    s$$$$$$$$$$$$$$$$$$$$$#######""'      s'         ,           
           $$..$$$$$$$$$$$$$$$$$$######"'       ....,$$....    ,$            
            "$$$$$$$$$$$$$$$######"' ,     .sS$$$$$$$$$$$$$$$$s$$            
              $$$$$$$$$$$$#####"     $, .s$$$$$$$$$$$$$$$$$$$$$$$$s.         
   )          $$$$$$$$$$$#####'      `$$$$$$$$$###########$$$$$$$$$$$.       
  ((          $$$$$$$$$$$#####       $$$$$$$$###"       "####$$$$$$$$$$      
  ) \         $$$$$$$$$$$$####.     $$$$$$###"             "###$$$$$$$$$   s'
 (   )        $$$$$$$$$$$$$####.   $$$$$###"                ####$$$$$$$$s$$' 
 )  ( (       $$"$$$$$$$$$$$#####.$$$$$###'                .###$$$$$$$$$$"   
 (  )  )   _,$"   $$$$$$$$$$$$######.$$##'                .###$$$$$$$$$$     
 ) (  ( \.         "$$$$$$$$$$$$$#######,,,.          ..####$$$$$$$$$$$"     
(   )$ )  )        ,$$$$$$$$$$$$$$$$$$####################$$$$$$$$$$$"       
(   ($$  ( \     _sS"  `"$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$S$$,       
 )  )$$$s ) )  .      .   `$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$"'  `$$      
  (   $$$Ss/  .$,    .$,,s$$$$$$##S$$$$$$$$$$$$$$$$$$$$$$$$S""        '      
    \)_$$$$$$$$$$$$$$$$$$$$$$$##"  $$        `$$.        `$$.                
        `"S$$$$$$$$$$$$$$$$$#"      $          `$          `$                
            `"""""""""""""'      
    '''
]


class Dragon(BaseCog, ErisEventMixin):
    def __init__(self, bot_instance: bot):
        super().__init__()
        self.bot = bot_instance

        self.dragon_regex: RETYPE = re.compile(
            r"dragon", flags=re.IGNORECASE
        )
        self.bot.add_listener(self.dragon, "on_message")

    async def dragon(self, message: discord.Message):
        keyword_in_message: bool = bool(
            self.dragon_regex.search(message.clean_content)
        )
        if not keyword_in_message:
            return

        ctx = await self.bot.get_context(message)

        async with self.lock_config.channel(message.channel).get_lock():
            allowed: bool = await self.allowed(ctx, message)
            if not allowed:
                return

            dragon = random.choice(dragonart)
            dragon = dragonart[-1]
            chunk = 1000
            if len(dragon) > chunk:
                n_splits = len(dragon) // chunk
                # print(f"Dragon too big! Sending in {n_splits} chunks")
                dragon_lines = dragon.split('\n')
                chunk_size = (len(dragon_lines) // n_splits) + 1
                for i in range(n_splits):
                    cdragon = '\n'.join(dragon_lines[i * chunk_size:(i + 1) * chunk_size])
                    formatted_dragon = f"```\n{cdragon}\n```"
                    # print(f"\t({i}) - {len(formatted_dragon)}")
                    await ctx.send(formatted_dragon)
            else:
                await ctx.send(f"```\n{dragon}\n```")

            await self.log_last_message(ctx, message)


if __name__ == '__main__':
    for dragon in dragonart:
        print(dragon)